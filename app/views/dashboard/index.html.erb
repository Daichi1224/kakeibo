<%= render "month_selector" %>

<div class="grid grid-3">
  <div class="card">
    <h2>Total</h2>
    <div class="big-number"><%= number_to_currency(@total, unit: "¥", precision: 0) %></div>
  </div>
  <div class="card">
    <h2>Transactions</h2>
    <div class="big-number"><%= @expenses.count %></div>
  </div>
  <div class="card">
    <h2>Categories</h2>
    <div class="big-number"><%= @category_totals.keys.count %></div>
  </div>
</div>

<div class="grid grid-2">
  <div class="card">
    <h2>Category Breakdown</h2>
    <%= pie_chart @category_totals, suffix: "円", donut: true %>
  </div>
  <div class="card">
    <h2>Daily Spending</h2>
    <%= column_chart @daily_totals, suffix: "円" %>
  </div>
</div>

<% food_total = @category_totals.select { |k, _| Expense::FOOD_CATEGORIES.include?(k) } %>
<% if food_total.any? %>
<div class="card">
  <h2>食費の内訳（外食 vs 自炊）</h2>
  <div class="grid grid-2">
    <div><%= pie_chart food_total, suffix: "円", donut: true %></div>
    <div style="display:flex; flex-direction:column; justify-content:center;">
      <% ft = food_total.values.sum %>
      <% food_total.each do |cat, amt| %>
        <p><strong><%= cat %></strong>: <%= number_to_currency(amt, unit: "¥", precision: 0) %>（<%= (amt.to_f / ft * 100).round(1) %>%）</p>
      <% end %>
      <p style="margin-top:8px; color: var(--text-muted);">食費合計: <%= number_to_currency(ft, unit: "¥", precision: 0) %></p>
    </div>
  </div>
</div>
<% end %>

<h3 class="section-title">Recent Expenses</h3>
<div class="card">
  <table>
    <thead>
      <tr>
        <th>Date</th>
        <th>Category</th>
        <th>Description</th>
        <th>Amount</th>
      </tr>
    </thead>
    <tbody>
      <% @recent_expenses.each do |expense| %>
        <tr>
          <td><%= expense.date.strftime("%m/%d") %></td>
          <td><span class="badge"><%= expense.category %></span></td>
          <td><%= expense.description %></td>
          <td><%= number_to_currency(expense.amount, unit: "¥", precision: 0) %></td>
        </tr>
      <% end %>
      <% if @recent_expenses.empty? %>
        <tr><td colspan="4" style="text-align:center; color: var(--text-muted);">No expenses yet</td></tr>
      <% end %>
    </tbody>
  </table>
</div>
